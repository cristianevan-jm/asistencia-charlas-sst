<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Administrador - Generar link</title>
  <style>
    body{font-family:system-ui,Arial;max-width:780px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 10px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ok{color:#0a7a0a;font-weight:700}
    .err{color:#b00020;font-weight:700}
    small{color:#666}
  </style>
</head>
<body>
  <h1 style=text-align:center>*** Admin - Generar link ***</h1>
  <p><small>Configura la actividad y evaluación. Se generará un link único para los colaboradores.</small></p>

  <div class="card">
    <div class="row">
      <div>
        <label>Empresa</label>
        <input id="empresa_admin" placeholder="Ej: COOTRAESCAL" required />
      </div>
      <div>
        <label>Número de charla</label>
        <select id="charla_admin" required>
          <option value="" disabled selected>Seleccione…</option>
           <option value="1">Charla 01 – La seguridad comienza conmigo</option>
        <option value="2">Charla 02 – Identificación de peligros en la operación de transporte</option>
        <option value="3">Charla 03 – Uso correcto de los elementos de protección personal (EPP)</option>
        <option value="4">Charla 04 – Fatiga y somnolencia en la conducción</option>
        <option value="5">Charla 05 – Alcohol, drogas y medicamentos: riesgos al conducir</option>
        <option value="6">Charla 06 – Ergonomía en el puesto de conducción</option>
        <option value="7">Charla 07 – Importancia de las pausas activas</option>
        <option value="8">Charla 08 – Estrés laboral en conductores</option>
        <option value="9">Charla 09 – Reporte de actos y condiciones inseguras</option>
        <option value="10">Charla 10 – Incidentes vs accidentes de trabajo</option>
        <option value="11">Charla 11 – Primeros auxilios básicos en carretera</option>
        <option value="12">Charla 12 – Atención y manejo de emergencias viales</option>
        <option value="13">Charla 13 – Inducción y reinducción en SG-SST</option>
        <option value="14">Charla 14 – Salud mental y bienestar del conductor</option>
        <option value="15">Charla 15 – Cultura del autocuidado en el transporte</option>
        <option value="16">Charla 16 – ¿Qué es el PESV y por qué es obligatorio?</option>
        <option value="17">Charla 17 – El conductor como actor vial responsable</option>
        <option value="18">Charla 18 – Exceso de velocidad y consecuencias viales</option>
        <option value="19">Charla 19 – Uso obligatorio del cinturón de seguridad</option>
        <option value="20">Charla 20 – Distracciones al volante (uso del celular)</option>
        <option value="21">Charla 21 – Inspección preoperacional del vehículo</option>
        <option value="22">Charla 22 – Documentación obligatoria del conductor y del vehículo</option>
        <option value="23">Charla 23 – Importancia del mantenimiento vehicular</option>
        <option value="24">Charla 24 – Conducción segura en condiciones climáticas adversas</option>
        <option value="25">Charla 25 – Principios del manejo defensivo</option>
        <option value="26">Charla 26 – Conducción segura en zonas rurales y urbanas</option>
        <option value="27">Charla 27 – Seguridad en el transporte de pasajeros</option>
        <option value="28">Charla 28 – Seguridad en el transporte de carga</option>
        <option value="29">Charla 29 – Protección de actores viales vulnerables</option>
        <option value="30">Charla 30 – Reporte e investigación de siniestros viales</option>
        <option value="31">Charla 31 – ¿Qué es la calidad en una empresa de transporte?</option>
        <option value="32">Charla 32 – El cliente interno y el cliente externo</option>
        <option value="33">Charla 33 – Cumplimiento de procedimientos operativos</option>
        <option value="34">Charla 34 – Atención y servicio al usuario</option>
        <option value="35">Charla 35 – Entregas oportunas y seguras</option>
        <option value="36">Charla 36 – Importancia de los registros y formatos</option>
        <option value="37">Charla 37 – Mejora continua en la operación</option>
        <option value="38">Charla 38 – No conformidades y acciones correctivas</option>
        <option value="39">Charla 39 – Indicadores de gestión en transporte</option>
        <option value="40">Charla 40 – Trabajo en equipo y comunicación efectiva</option>
        <option value="41">Charla 41 – ¿Qué es un Sistema Integrado de Gestión?</option>
        <option value="42">Charla 42 – Cumplimiento legal en transporte</option>
        <option value="43">Charla 43 – Roles y responsabilidades en el SIG</option>
        <option value="44">Charla 44 – Gestión integral de riesgos</option>
        <option value="45">Charla 45 – Cultura organizacional en seguridad y calidad</option>
        <option value="46">Charla 46 – Comunicación interna del SIG</option>
        <option value="47">Charla 47 – Auditorías internas: qué son y para qué sirven</option>
        <option value="48">Charla 48 – Lecciones aprendidas de incidentes y accidentes</option>
        <option value="49">Charla 49 – Importancia de la documentación del SIG</option>
        <option value="50">Charla 50 – Compromiso de la alta dirección con el SIG</option>
        <option value="51">Charla 51 – Ética y comportamiento del conductor profesional</option>
        <option value="52">Charla 52 – Respeto por la vida en la vía</option>
        <option value="53">Charla 53 – Toma de decisiones seguras bajo presión</option>
        <option value="54">Charla 54 – Comunicación asertiva con usuarios y compañeros</option>
        <option value="55">Charla 55 – Liderazgo en seguridad vial</option>
        <option value="56">Charla 56 – Responsabilidad social en el transporte</option>
        <option value="57">Charla 57 – Autocontrol emocional al conducir</option>
        <option value="58">Charla 58 – La seguridad y la calidad salvan vidas</option>
        <option value="59">Charla 59 – La seguridad y la calidad salvan vidas (Refuerzo 2)</option>
        <option value="60">Charla 60 – La seguridad y la calidad salvan vidas (Refuerzo 3)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Actividad</label>
        <select id="actividad_admin" required>
          <option value="" disabled selected>Seleccione…</option>
          <option value="Socialización">Socialización</option>
          <option value="Capacitación">Capacitación</option>
          <option value="Reunión">Reunión</option>
          <option value="Taller">Taller</option>
        </select>
      </div>
      <div>
        <label>Responsable</label>
        <input id="responsable_admin" placeholder="Nombre del responsable" required />
      </div>
      <div class="row">
  <div>
    <label>Duración (minutos)</label>
    <input id="duracion_admin" type="number" min="1" placeholder="Ej: 5" />
  </div>
  <div>
    <label>Tipo de Reunión (si aplica)</label>
    <select id="reunion_tipo_admin">
      <option value="" selected>—</option>
      <option value="COPASST">COPASST</option>
      <option value="COMITE_DE_CONVIVENCIA">COMITÉ DE CONVIVENCIA</option>
      <option value="COMITE_DE_SEGURIDAD_VIAL">COMITÉ DE SEGURIDAD VIAL</option>
    </select>
    <small>Solo se habilita cuando Actividad = Reunión</small>
  </div>
</div>

    </div>

    <label>Objetivo</label>
    <textarea id="objetivo_admin" rows="2" placeholder="Ej: Sensibilizar sobre..." required></textarea>

    <label>Temas a tratar (puedes escribir varios)</label>
    <textarea id="temas_admin" rows="3" placeholder="- Tema 1&#10;- Tema 2&#10;- Tema 3" required></textarea>

    <label>Preguntas de evaluación (una por línea) - Verdadero/Falso</label>
    <textarea id="preguntas_admin" rows="6" placeholder="Ej:
El cinturón se debe usar siempre.
La inspección preoperacional es opcional.
Si estoy fatigado, debo reportarlo."></textarea>
    <small>Recomendado: 3–10 preguntas cortas (máx. 15).</small>

    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="btn_generar">Generar link</button>
      <button id="btn_copiar" type="button">Copiar</button>
      <span id="msg"></span>
    </div>

    <div style="margin-top:12px">
      <label>Link generado</label>
      <input id="link" readonly />
    </div>
  </div>

 <script>
  const empresa = document.getElementById("empresa_admin");
  const charla = document.getElementById("charla_admin");
  const actividad = document.getElementById("actividad_admin");
  const responsable = document.getElementById("responsable_admin");
  const duracion = document.getElementById("duracion_admin");
  const reunionTipo = document.getElementById("reunion_tipo_admin");

  const objetivo = document.getElementById("objetivo_admin");
  const temas = document.getElementById("temas_admin");
  const preguntas = document.getElementById("preguntas_admin");

  const link = document.getElementById("link");
  const msg = document.getElementById("msg");

  function getBaseIndexUrl() {
    const url = new URL(window.location.href);
    url.pathname = url.pathname.replace(/admin\.html$/i, "index.html");
    url.search = "";
    url.hash = "";
    return url.toString();
  }

  function normalizeLines(text, limit) {
    return text.split(/\r?\n/).map(s => s.trim()).filter(Boolean).slice(0, limit);
  }

  function setEnabled(el, enabled) {
    el.disabled = !enabled;
    el.readOnly = !enabled;
    if (!enabled) el.value = "";
  }

  function setActividadRules() {
    const act = actividad.value;

    // Siempre habilitados (base)
    setEnabled(empresa, true);
    setEnabled(responsable, true); // en tu requerimiento: responsable se habilita en reunion/cap/taller
    setEnabled(objetivo, true);
    setEnabled(temas, true);
    setEnabled(duracion, true);
    setEnabled(preguntas, true);

    // Defaults
    reunionTipo.disabled = true;
    reunionTipo.value = "";

    // 1) SOCIALIZACIÓN:
    // - se carga lista de charlas (ya la tienes)
    // - NO se habilita preguntas
    // - (puedes decidir si objetivo/temas/responsable van o no: tú no pediste habilitarlos aquí)
    if (act === "Socialización") {
      // Lista charlas: charla_admin habilitada
      charla.disabled = false;

      // Bloquear preguntas
      setEnabled(preguntas, false);

      // Para socialización normalmente sí hay responsable/objetivo/temas,
      // pero si quieres “solo charla”, descomenta esto:
      // setEnabled(objetivo, false);
      // setEnabled(temas, false);
      // setEnabled(responsable, false);
      // setEnabled(duracion, false);
    }

    // 2) REUNIÓN:
    // - el selector principal (charla_admin) no debe ser “charla”
    // - debe ser COPASST / Convivencia / Seguridad Vial
    // - habilitar Tema, Objetivo, Responsable, Duración, Preguntas
    if (act === "Reunión") {
      // No usar charlas aquí: deshabilito el select de charlas
      charla.value = "";
      charla.disabled = true;

      // Habilitar tipo reunión
      reunionTipo.disabled = false;

      // Habilitar campos
      setEnabled(temas, true);
      setEnabled(objetivo, true);
      setEnabled(responsable, true);
      setEnabled(duracion, true);
      setEnabled(preguntas, true);
    }

    // 3) CAPACITACIÓN / TALLER:
    // - se usa lista de charlas
    // - habilitar Tema, Objetivo, Responsable, Duración, Preguntas
    if (act === "Capacitación" || act === "Taller") {
      charla.disabled = false;
      setEnabled(temas, true);
      setEnabled(objetivo, true);
      setEnabled(responsable, true);
      setEnabled(duracion, true);
      setEnabled(preguntas, true);
    }
  }

  actividad.addEventListener("change", setActividadRules);
  setActividadRules();

  document.getElementById("btn_generar").addEventListener("click", (e) => {
    e.preventDefault();
    msg.textContent = "";
    msg.className = "";

    const act = actividad.value;

    // Validaciones según actividad
    if (!empresa.value.trim() || !act) {
      msg.textContent = "❌ Completa Empresa y Actividad";
      msg.className = "err";
      return;
    }

    // Reunión exige tipo de reunión
    if (act === "Reunión" && !reunionTipo.value) {
      msg.textContent = "❌ Selecciona el tipo de Reunión (COPASST / Convivencia / Seguridad Vial)";
      msg.className = "err";
      return;
    }

    // Capacitación/Taller/Socialización exigen charla
    if ((act === "Capacitación" || act === "Taller" || act === "Socialización") && !charla.value) {
      msg.textContent = "❌ Selecciona el Número de charla";
      msg.className = "err";
      return;
    }

    // Para Reunión/Cap/Taller pediste habilitar y exigir estos campos:
    if (act === "Reunión" || act === "Capacitación" || act === "Taller") {
      if (!responsable.value.trim() || !duracion.value.trim() || !objetivo.value.trim() || !temas.value.trim()) {
        msg.textContent = "❌ Completa Responsable, Duración, Objetivo y Temas";
        msg.className = "err";
        return;
      }
    }

    // Para Socialización: objetivo/temas/responsable pueden ser opcionales o requeridos (tú defines)
    // Aquí los dejo requeridos como estaba tu lógica original:
    if (act === "Socialización") {
      if (!responsable.value.trim() || !objetivo.value.trim() || !temas.value.trim()) {
        msg.textContent = "❌ Completa Responsable, Objetivo y Temas (Socialización)";
        msg.className = "err";
        return;
      }
    }

    const qs = normalizeLines(preguntas.value, 15);
    const u = new URL(getBaseIndexUrl());

    u.searchParams.set("empresa", empresa.value.trim());
    u.searchParams.set("actividad", act);
    u.searchParams.set("responsable", responsable.value.trim());
    u.searchParams.set("objetivo", objetivo.value.trim());
    u.searchParams.set("temas", temas.value.trim());

    if (duracion.value.trim()) u.searchParams.set("duracion", duracion.value.trim());

    if (act === "Reunión") {
      u.searchParams.set("reunion_tipo", reunionTipo.value);
      // no hay charla_num
    } else {
      u.searchParams.set("charla_num", charla.value);
    }

    // Preguntas:
    // - Socialización: NO debe ir preguntas
    // - Reunión/Cap/Taller: sí
    if (act !== "Socialización" && qs.length) {
      u.searchParams.set("q", qs.join("||"));
    }

    link.value = u.toString();
    msg.textContent = "✅ Link generado";
    msg.className = "ok";
  });

  document.getElementById("btn_copiar").addEventListener("click", async () => {
    if (!link.value) {
      msg.textContent = "❌ Primero genera el link";
      msg.className = "err";
      return;
    }
    try {
      await navigator.clipboard.writeText(link.value);
      msg.textContent = "✅ Copiado";
      msg.className = "ok";
    } catch {
      link.select();
      document.execCommand("copy");
      msg.textContent = "✅ Copiado";
      msg.className = "ok";
    }
  });
</script>

</body>
</html>



