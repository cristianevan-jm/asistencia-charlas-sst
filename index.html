<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Asistencia</title>

  <style>
    *{ box-sizing:border-box; }
    body{font-family:system-ui,Arial;max-width:780px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 10px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row>div{min-width:0}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
    textarea{resize:vertical}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    .ok{color:#0a7a0a;font-weight:700}
    small{color:#666}
    @media (max-width:680px){ .row{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <h1 style="text-align:center">*** Asistencia ***</h1>

  <div class="card">
    <iframe name="hidden_iframe" style="display:none;"></iframe>

    <form id="frm"
      action="https://script.google.com/macros/s/AKfycbyvIm8wUl7yv5vDixOGPZbahV-UfeNJ_54iRPvhnyYHU5WTZ0oBAWI8Cr8qKz0RF6Lcpw/exec"
      method="POST"
      target="hidden_iframe">

      <div class="row">
        <div>
          <label>Nombre</label>
          <input name="nombre" required>
        </div>
        <div>
          <label>Apellido</label>
          <input name="apellido" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cédula</label>
          <input name="cedula" required>
        </div>
        <div>
          <label>Cargo</label>
          <input name="cargo" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ciudad</label>
          <input name="ciudad" required>
        </div>
        <div>
          <label>Lateral / Placa</label>
          <input name="lateral" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Empresa</label>
          <input name="empresa" id="empresa" required>
        </div>
        <div>
          <label>Contrato / Servicio</label>
          <input name="contrato" required>
        </div>
      </div>

      <label>Actividad</label>
      <input name="actividad" id="actividad" readonly>

      <label>Responsable</label>
      <input name="responsable" id="responsable" readonly>

      <label>Duración (minutos)</label>
      <input name="duracion" id="duracion" readonly>

      <label>Tipo de Reunión</label>
      <input name="reunion_tipo" id="reunion_tipo" readonly>

      <label>Objetivo</label>
      <textarea name="objetivo" id="objetivo" rows="2" readonly></textarea>

      <label>Temas</label>
      <textarea name="temas" id="temas" rows="3" readonly></textarea>

      <!-- Charla: solo Socialización -->
      <div id="charla_box" style="display:none">
  <label>Charla (N°)</label>
  <input type="hidden" name="charla_num" id="charla_num">
  <input type="hidden" name="charla_texto" id="charla_texto">
  <select id="charla_select" disabled></select>
</div>
      <div id="preguntas_box"></div>

      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button type="submit">Enviar asistencia</button>
        <span id="msg"></span>
      </div>
    </form>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);

  // Carga parámetros
  const actividadParam = params.get("actividad") || "";
  const charlaNumParam = params.get("charla_num") || "";
  const charlaTextoParam = params.get("charla_texto") || "";
  const preguntasParam = params.get("q") || "";

  // Set campos desde el link
  ["empresa","actividad","responsable","duracion","reunion_tipo","objetivo","temas"].forEach(id=>{
    const el = document.getElementById(id);
    const val = params.get(id);
    if (el && val !== null) el.value = val;
  });

  // Empresa: si viene por link, bloquear edición
  const empresaInput = document.getElementById("empresa");
  if (params.get("empresa")) empresaInput.readOnly = true;

  // Charla solo Socialización
  const charlaBox = document.getElementById("charla_box");
  const charlaHidden = document.getElementById("charla_num");
  const charlaSelect = document.getElementById("charla_select");

  const charlaTextoHidden = document.getElementById("charla_texto");

if (actividadParam === "Socialización" && charlaNumParam) {
  charlaBox.style.display = "block";
  charlaHidden.value = charlaNumParam;

  const texto = charlaTextoParam || `Charla ${String(charlaNumParam).padStart(2,"0")}`;
  charlaTextoHidden.value = texto; // ✅ esto viaja al Sheet
  charlaSelect.innerHTML = `<option selected>${texto}</option>`;
} else {
  charlaBox.style.display = "none";
  charlaHidden.value = "";
  charlaTextoHidden.value = "";
}


  // Preguntas: NO en Socialización
  const box = document.getElementById("preguntas_box");
  const preguntas = preguntasParam ? preguntasParam.split("||").map(s=>s.trim()).filter(Boolean) : [];

  if (actividadParam !== "Socialización" && preguntas.length) {
    const h = document.createElement("label");
    h.textContent = "Evaluación (Verdadero / Falso)";
    box.appendChild(h);

    preguntas.forEach((q, idx) => {
      const wrap = document.createElement("div");
      wrap.style.marginTop = "10px";

      const lab = document.createElement("label");
      lab.textContent = (idx + 1) + ". " + q;
      wrap.appendChild(lab);

      const sel = document.createElement("select");
      sel.name = "resp_" + (idx + 1);
      sel.required = true;
      sel.innerHTML = `
        <option value="" disabled selected>Seleccione…</option>
        <option value="Verdadero">Verdadero</option>
        <option value="Falso">Falso</option>
      `;
      wrap.appendChild(sel);

      const hiddenQ = document.createElement("input");
      hiddenQ.type = "hidden";
      hiddenQ.name = "preg_" + (idx + 1);
      hiddenQ.value = q;
      wrap.appendChild(hiddenQ);

      box.appendChild(wrap);
    });

    const n = document.createElement("input");
    n.type = "hidden";
    n.name = "n_preguntas";
    n.value = String(preguntas.length);
    box.appendChild(n);
  }

  // Reset Selectivo
  const frm = document.getElementById("frm");
  const msg = document.getElementById("msg");

  function resetSelective() {
    frm.querySelectorAll('input:not([type="hidden"]):not([readonly]):not([disabled])')
      .forEach(i => i.value = "");

    frm.querySelectorAll('select:not([disabled])')
      .forEach(s => s.selectedIndex = 0);

    frm.querySelectorAll('textarea:not([readonly]):not([disabled])')
      .forEach(t => t.value = "");
  }

  frm.addEventListener("submit", () => {
    msg.textContent = "Enviando…";
    msg.className = "";

    setTimeout(() => {
      msg.textContent = "✅ Registro guardado";
      msg.className = "ok";
      resetSelective();
    }, 900);
  });
</script>

</body>
</html>



