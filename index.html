<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Asistencia Charlas SST</title>

  <style>
    *{ box-sizing:border-box; }
    body{font-family:system-ui,Arial;max-width:780px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 10px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:600}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row > div{min-width:0}

    input,select,textarea{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:10px
    }

    textarea{resize:vertical}

    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
    .ok{color:#0a7a0a;font-weight:700}
    .err{color:#b00020;font-weight:700}
    small{color:#666}

    @media (max-width:680px){
      .row{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <h1 style="text-align:center">*** Asistencia Charlas SST ***</h1>

  <div style="text-align:center;margin-bottom:10px">
    <img src="logo.jpeg" alt="Logo empresa" style="max-height:90px">
  </div>

  <p style="text-align:center"><small>Registro único de asistencia y comprensión.</small></p>

  <div class="card">
    <iframe name="hidden_iframe" style="display:none;"></iframe>

    <form id="frm"
      action="https://script.google.com/macros/s/AKfycbyKhnawVrZXCq0BGY1fOKy5syNYr5LZU9sjbWjYi6R6aSIcStxV8Z2-QW1dpYFX-xe1iQ/exec"
      method="POST"
      target="hidden_iframe">

      <!-- DATOS DEL COLABORADOR -->
      <div class="row">
        <div>
          <label>Nombre</label>
          <input name="nombre" required>
        </div>
        <div>
          <label>Apellido</label>
          <input name="apellido" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cédula</label>
          <input name="cedula" required>
        </div>
        <div>
          <label>Cargo</label>
          <input name="cargo" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ciudad</label>
          <input name="ciudad" required>
        </div>
        <div>
          <label>Lateral / Placa</label>
          <input name="lateral" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Empresa</label>
          <input name="empresa" id="empresa" required>
        </div>
        <div>
          <label>Contrato / Servicio</label>
          <input name="contrato" required>
        </div>
      </div>

      <!-- DATOS DE LA ACTIVIDAD (DESDE LINK) -->
      <label>Actividad</label>
      <input name="actividad" id="actividad" readonly>

      <label>Responsable</label>
      <input name="responsable" id="responsable" readonly>

      <label>Duración (minutos)</label>
      <input name="duracion" id="duracion" readonly>

      <label>Tipo de Reunión</label>
      <input name="reunion_tipo" id="reunion_tipo" readonly>

      <label>Objetivo</label>
      <textarea name="objetivo" id="objetivo" rows="2" readonly></textarea>

      <label>Temas</label>
      <textarea name="temas" id="temas" rows="3" readonly></textarea>

      <!-- CHARLA SOLO PARA SOCIALIZACIÓN -->
      <div id="charla_box">
        <label>Charla (N°)</label>
        <input type="hidden" name="charla_num" id="charla_num">
        <select id="charla_select" disabled>
          <option value="" disabled selected>—</option>
        </select>
      </div>

      <!-- PREGUNTAS -->
      <div id="preguntas_box"></div>

      <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
        <button type="submit">Enviar asistencia</button>
        <span id="msg"></span>
      </div>
    </form>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);

  const actividad = params.get("actividad") || "";
  const preguntasParam = params.get("q") || "";

  // Campos fijos
  ["empresa","actividad","responsable","duracion","reunion_tipo","objetivo","temas"]
    .forEach(id=>{
      const el=document.getElementById(id);
      if(el && params.get(id)) el.value=params.get(id);
    });

  // Charla
  const charlaBox = document.getElementById("charla_box");
  const charlaHidden = document.getElementById("charla_num");
  const charlaParam = params.get("charla_num");

  if (actividad === "Socialización" && charlaParam) {
    charlaHidden.value = charlaParam;
    charlaBox.style.display = "block";
    document.getElementById("charla_select").innerHTML =
      `<option selected>Charla ${charlaParam}</option>`;
  } else {
    charlaBox.style.display = "none";
  }

  // Preguntas
  const box = document.getElementById("preguntas_box");
  const preguntas = preguntasParam ? preguntasParam.split("||").filter(Boolean) : [];

  if (actividad !== "Socialización" && preguntas.length) {
    const h=document.createElement("label");
    h.textContent="Evaluación (Verdadero / Falso)";
    box.appendChild(h);

    preguntas.forEach((q,i)=>{
      box.insertAdjacentHTML("beforeend",`
        <label>${i+1}. ${q}</label>
        <select name="resp_${i+1}" required>
          <option value="" disabled selected>Seleccione…</option>
          <option value="Verdadero">Verdadero</option>
          <option value="Falso">Falso</option>
        </select>
        <input type="hidden" name="preg_${i+1}" value="${q}">
      `);
    });

    box.insertAdjacentHTML("beforeend",
      `<input type="hidden" name="n_preguntas" value="${preguntas.length}">`);
  }

  // RESET SELECTIVO
  const frm=document.getElementById("frm");
  const msg=document.getElementById("msg");

  function resetSelective(){
    frm.querySelectorAll('input:not([readonly]):not([type=hidden])').forEach(i=>i.value="");
    frm.querySelectorAll('select:not([readonly])').forEach(s=>s.selectedIndex=0);
  }

  frm.addEventListener("submit",()=>{
    msg.textContent="Enviando…";
    setTimeout(()=>{
      msg.textContent="✅ Registro guardado";
      msg.className="ok";
      resetSelective();
    },900);
  });
</script>

</body>
</html>

